import streamlit as st
import numpy as np
from PIL import Image
from tensorflow.keras.preprocessing import image
from tensorflow.keras.models import load_model

# Cargar el modelo desde el repositorio
@st.cache_resource
def load_cnn_model():
    return load_model("skin_cancer_cnn.h5")

model = load_cnn_model()

def predict_skin_cancer(uploaded_file, model):
    img = Image.open(uploaded_file).convert("RGB")
    img = img.resize((224, 224))

    img_array = image.img_to_array(img) / 255.0
    img_array = np.expand_dims(img_array, axis=0)

    prediction = model.predict(img_array)
    class_label = "Maligne" if prediction > 0.5 else "Benigne"

    return class_label, img


# UI
st.title("Detector de Melanoma")

st.markdown("""
Aquest és un detector de càncer de pell.
Adjunta una imatge i el model indicarà si el melanoma és benigne o maligne.
""")

uploaded_image = st.file_uploader(
    "Escull una imatge...", type=["jpg", "jpeg", "png"]
)

if uploaded_image is not None:
    class_label, img = predict_skin_cancer(uploaded_image, model)

    st.image(img, caption="Imatge analitzada", width=400)
    st.write(f"### Predicció: **{class_label}**")

st.markdown("""
### Informació sobre el model
Aquest model utilitza xarxes neuronals convolucionals entrenades amb imatges mèdiques.
No es garanteix una bona precisió amb fotografies fetes amb mòbil.
""")
